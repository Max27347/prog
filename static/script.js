document.addEventListener('DOMContentLoaded', () => {
  const clickButton = document.getElementById('clickButton');
  const currentScoreElement = document.querySelector('.currentScore');
  const progressBar = document.querySelector('#progressBar');
  const progressLabel = document.querySelector('#progressLabel');
  const energyDisplay = document.querySelector('#energyDisplay'); // –≠–ª–µ–º–µ–Ω—Ç –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —ç–Ω–µ—Ä–≥–∏–∏
  const coinContainer = document.querySelector('#coinContainer');

  let progress = 0;
  const maxProgress = 100;
  let leagueLevel = 0;
  let clicksPerLevel = 10;

  // –°–¥–µ–ª–∞–µ–º energy –∏ maxEnergy –≥–ª–æ–±–∞–ª—å–Ω—ã–º–∏ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–º–∏ —á–µ—Ä–µ–∑ window
  window.energy = parseInt(localStorage.getItem('currentEnergy'), 10) || 100;
  window.maxEnergy = parseInt(localStorage.getItem('maxEnergy'), 10) || 100;
  const energyCost = 10;
  window.energyRecoveryRate = parseInt(localStorage.getItem('energyRecoveryRate'), 10) || 5;
  window.coinsPerClick = 1;  // –ì–ª–æ–±–∞–ª—å–Ω–∞—è –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è –¥–ª—è –º–æ–Ω–µ—Ç –∑–∞ –∫–ª–∏–∫

  // –ó–∞–≥—Ä—É–∑–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
  const savedCoinsPerClick = localStorage.getItem('coinsPerClick');
  if (savedCoinsPerClick) {
    window.coinsPerClick = parseInt(savedCoinsPerClick, 10);
  }

  const savedLeagueLevel = localStorage.getItem('leagueLevel');
  if (savedLeagueLevel !== null) {
    leagueLevel = parseInt(savedLeagueLevel, 10);
    setLeagueBackground(leagueLevel);
  }

  const savedEnergy = localStorage.getItem('currentEnergy');
  if (savedEnergy !== null) {
    window.energy = parseInt(savedEnergy, 10);
    energyDisplay.textContent = `${Math.round(window.energy)}/${window.maxEnergy}`; // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º —Ç–µ–∫—É—â—É—é —ç–Ω–µ—Ä–≥–∏—é –∫–∞–∫ —Ü–µ–ª–æ–µ —á–∏—Å–ª–æ
  }

  const savedProgress = localStorage.getItem('currentProgress');
  if (savedProgress !== null) {
    progress = parseFloat(savedProgress);
    progressBar.style.width = `${progress}%`;
  }

  // –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –≥–µ—Ä–æ—è
  const savedCharacterImg = localStorage.getItem('selectedCharacterImg');
  if (savedCharacterImg) {
    clickButton.src = savedCharacterImg;
  }

window.updateClickButtonImage = (imgSrc) => {
  const clickButton = document.getElementById('clickButton');
  if (clickButton) {
    clickButton.src = imgSrc;
  }
};

  // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≥–ª–æ–±–∞–ª—å–Ω–æ–π –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π coinsPerClick –∏ –µ–µ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
  window.updateCoinsPerClick = (newCoinsPerClick) => {
    window.coinsPerClick = newCoinsPerClick;
    localStorage.setItem('coinsPerClick', newCoinsPerClick);

    const coinsPerClickDisplay = document.getElementById('coinsPerClickDisplay');
    if (coinsPerClickDisplay) {
      coinsPerClickDisplay.textContent = `–ú–æ–Ω–µ—Ç –∑–∞ –∫–ª–∏–∫: ${window.coinsPerClick}`;
    }
  };

  // –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–µ–º –≥–ª–æ–±–∞–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
  window.updateEnergyRecoveryRate = (newRate) => {
    window.energyRecoveryRate = newRate;
    localStorage.setItem('energyRecoveryRate', newRate);

    const energyRecoveryRateDisplay = document.getElementById('energyRecoveryRateDisplay');
    if (energyRecoveryRateDisplay) {
      energyRecoveryRateDisplay.textContent = `–°–∫–æ—Ä–æ—Å—Ç—å –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è —ç–Ω–µ—Ä–≥–∏–∏: ${newRate}`;
    }
  };

  // –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ —ç–Ω–µ—Ä–≥–∏–∏
  function recoverEnergy() {
    const recoveryRate = window.energyRecoveryRate; // –ü–æ–ª—É—á–∞–µ–º –∞–∫—Ç—É–∞–ª—å–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ
    window.energy = Math.min(window.energy + recoveryRate / 10, window.maxEnergy); // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—É—é —ç–Ω–µ—Ä–≥–∏—é maxEnergy
    energyDisplay.textContent = `${Math.round(window.energy)}/${window.maxEnergy}`; // –û–±–Ω–æ–≤–ª—è–µ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —ç–Ω–µ—Ä–≥–∏–∏
  }

  setInterval(recoverEnergy, 50); // –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ —ç–Ω–µ—Ä–≥–∏–∏ –∫–∞–∂–¥—ã–µ 50 –º—Å

  // –ö–ª–∏–∫–µ—Ä
  clickButton.onclick = async (event) => {
    if (window.energy >= energyCost) {
      try {
        const response = await fetch('/click', { method: 'POST' });
        const data = await response.json();

        if (data.success) {
          let score = parseInt(currentScoreElement.innerText) || 0;

          // –ò—Å–ø–æ–ª—å–∑—É–µ–º –∞–∫—Ç—É–∞–ª—å–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ window.coinsPerClick
          score += window.coinsPerClick;  // –í–º–µ—Å—Ç–æ coinsPerClick –∏—Å–ø–æ–ª—å–∑—É–µ–º window.coinsPerClick
          updateScore(score);

          // –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç window.coinsPerClick
          const progressIncrement = (maxProgress / clicksPerLevel) * window.coinsPerClick;
          progress = Math.min(progress + progressIncrement, maxProgress);
          progressBar.style.width = `${progress}%`;
          localStorage.setItem('currentProgress', progress);

          window.energy = Math.max(window.energy - energyCost, 0);
          energyDisplay.textContent = `${Math.round(window.energy)}/${window.maxEnergy}`; // –û–±–Ω–æ–≤–ª—è–µ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —ç–Ω–µ—Ä–≥–∏–∏

        const selectedCharacter = localStorage.getItem('selectedCharacter');

        if (selectedCharacter === "1") {
          createFlashEffect(event); // ‚ö° –í—Å–ø—ã—à–∫–∞ —É –ø–µ—Ä–≤–æ–≥–æ –ø–µ—Ä—Å–æ–Ω–∞–∂–∞
        } else if (selectedCharacter === "2") {
          spawnCoinDrop(event); // üí∞ –ú–æ–Ω–µ—Ç—ã —É –≤—Ç–æ—Ä–æ–≥–æ –ø–µ—Ä—Å–æ–Ω–∞–∂–∞
         } else if (selectedCharacter === "3") {
          createFireEffect(event); // üî• –û–≥–æ–Ω—å —É —Ç—Ä–µ—Ç—å–µ–≥–æ –ø–µ—Ä—Å–æ–Ω–∞–∂–∞
        }


          if (progress === maxProgress) {
            updateLeague();
            progress = 0;
            progressBar.style.width = '0%';
            localStorage.setItem('currentProgress', 0);
          }
        }
      } catch (error) {
        console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ —Å—á–µ—Ç–∞:", error);
      }
    }
  };

  // –§—É–Ω–∫—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—á–µ—Ç–∞
  function updateScore(newScore) {
    const scoreElements = document.querySelectorAll('.currentScore');
    scoreElements.forEach((element) => {
      element.innerText = newScore;
    });

    localStorage.setItem('currentScore', newScore);
  }

  // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ª–∏–≥–∏
  function updateLeague() {
    leagueLevel++;
    localStorage.setItem('leagueLevel', leagueLevel); // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–µ–∫—É—â–∏–π —É—Ä–æ–≤–µ–Ω—å –ª–∏–≥–∏
    setLeagueBackground(leagueLevel); // –û–±–Ω–æ–≤–ª—è–µ–º —Ñ–æ–Ω
  }

  // –§—É–Ω–∫—Ü–∏—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏ —Ñ–æ–Ω–∞ –¥–ª—è –ª–∏–≥–∏
  function setLeagueBackground(level) {
    const body = document.body; // –≠–ª–µ–º–µ–Ω—Ç, —Ñ–æ–Ω –∫–æ—Ç–æ—Ä–æ–≥–æ –±—É–¥–µ–º –º–µ–Ω—è—Ç—å
    let backgroundImage = '';

    switch (level) {
      case 1:
        progressLabel.innerText = '–õ–µ–¥—è–Ω–æ–π –º–∏—Ä';
        clicksPerLevel = 5;
        backgroundImage = '/static/images/ice.png'; // –£–∫–∞–∂–∏—Ç–µ –ø—É—Ç—å –∫ —Ñ–æ–Ω—É –°–µ—Ä–µ–±—Ä—è–Ω–æ–π –ª–∏–≥–∏
        break;
      case 2:
        progressLabel.innerText = '–ê–¥—Å–∫–∏–π –º–∏—Ä';
        clicksPerLevel = 6;
        backgroundImage = '/static/images/ad.png'; // –£–∫–∞–∂–∏—Ç–µ –ø—É—Ç—å –∫ —Ñ–æ–Ω—É –ó–æ–ª–æ—Ç–æ–π –ª–∏–≥–∏
        break;
      case 3:
        progressLabel.innerText = '–ö–∏—Ç–∞–π';
        clicksPerLevel = 7;
        backgroundImage = '/static/images/china.png'; // –£–∫–∞–∂–∏—Ç–µ –ø—É—Ç—å –∫ —Ñ–æ–Ω—É –ê–ª–º–∞–∑–Ω–æ–π –ª–∏–≥–∏
        break;
      case 4:
        progressLabel.innerText = '–í–æ–¥–Ω—ã–π –º–∏—Ä';
        clicksPerLevel = 8;
        backgroundImage = '/static/images/water_world.png'; // –£–∫–∞–∂–∏—Ç–µ –ø—É—Ç—å –∫ —Ñ–æ–Ω—É –ê–ª–º–∞–∑–Ω–æ–π –ª–∏–≥–∏
        break;
      case 5:
        progressLabel.innerText = '–ú–∏—Å—Ç–∏–∫–∞';
        clicksPerLevel = 8;
        backgroundImage = '/static/images/mystical.png'; // –£–∫–∞–∂–∏—Ç–µ –ø—É—Ç—å –∫ —Ñ–æ–Ω—É –ê–ª–º–∞–∑–Ω–æ–π –ª–∏–≥–∏
        break;
      case 6:
        progressLabel.innerText = '–ö—É–±–∏—á–µ—Å–∫–∏–π –º–∏—Ä';
        clicksPerLevel = 10;
        backgroundImage = '/static/images/minecraft.png'; // –£–∫–∞–∂–∏—Ç–µ –ø—É—Ç—å –∫ —Ñ–æ–Ω—É –ê–ª–º–∞–∑–Ω–æ–π –ª–∏–≥–∏
        break;
      case 7:
        progressLabel.innerText = '–¢—å–º–∞';
        clicksPerLevel = 11;
        backgroundImage = '/static/images/dark.png'; // –£–∫–∞–∂–∏—Ç–µ –ø—É—Ç—å –∫ —Ñ–æ–Ω—É –ê–ª–º–∞–∑–Ω–æ–π –ª–∏–≥–∏
        break;
      case 8:
        progressLabel.innerText = '–ö–æ—Å–º–æ—Å';
        clicksPerLevel = 12;
        backgroundImage = '/static/images/cosmos.png'; // –£–∫–∞–∂–∏—Ç–µ –ø—É—Ç—å –∫ —Ñ–æ–Ω—É –ê–ª–º–∞–∑–Ω–æ–π –ª–∏–≥–∏
        break;
      case 9:
        progressLabel.innerText = '–¢–µ–º–Ω–æ—Ç–∞';
        clicksPerLevel = 13;
        backgroundImage = '/static/images/dark_2.png'; // –£–∫–∞–∂–∏—Ç–µ –ø—É—Ç—å –∫ —Ñ–æ–Ω—É –ê–ª–º–∞–∑–Ω–æ–π –ª–∏–≥–∏
        break;
      case 10:
        progressLabel.innerText = '–ù–õ–û';
        clicksPerLevel = 14;
        backgroundImage = '/static/images/plat.png'; // –£–∫–∞–∂–∏—Ç–µ –ø—É—Ç—å –∫ —Ñ–æ–Ω—É –ê–ª–º–∞–∑–Ω–æ–π –ª–∏–≥–∏
        break;
      default:
        progressLabel.innerText = '–î–µ—Ä–µ–≤–Ω—è';
        leagueLevel = 0;
        clicksPerLevel = 5;
        backgroundImage = '/static/images/hogwarts.png'; // –£–∫–∞–∂–∏—Ç–µ –ø—É—Ç—å –∫ –Ω–∞—á–∞–ª—å–Ω–æ–º—É —Ñ–æ–Ω—É
    }

    // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ñ–æ–Ω —Å –Ω—É–∂–Ω—ã–º —Ä–∞–∑–º–µ—Ä–æ–º
    body.style.backgroundImage = `url("${backgroundImage}")`; // –ò—Å–ø–æ–ª—å–∑—É–µ–º –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π —Å–∏–Ω—Ç–∞–∫—Å–∏—Å
    body.style.backgroundSize = 'cover'; // –†–∞—Å—Ç—è–≥–∏–≤–∞–µ–º —Ñ–æ–Ω –Ω–∞ –≤–µ—Å—å —ç–∫—Ä–∞–Ω
    body.style.backgroundPosition = 'center'; // –¶–µ–Ω—Ç—Ä–∏—Ä—É–µ–º —Ñ–æ–Ω
    body.style.backgroundAttachment = 'fixed'; // –§–∏–∫—Å–∏—Ä—É–µ–º —Ñ–æ–Ω –ø—Ä–∏ –ø—Ä–æ–∫—Ä—É—Ç–∫–µ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)

    // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ñ–æ–Ω –≤ localStorage
    localStorage.setItem('backgroundImage', backgroundImage);
  };

// ‚ö° –§—É–Ω–∫—Ü–∏—è —Å–æ–∑–¥–∞–Ω–∏—è —ç—Ñ—Ñ–µ–∫—Ç–∞ –º–æ–ª–Ω–∏–∏ –≤ —Ç–æ—á–∫–µ –∫–ª–∏–∫–∞
function createFlashEffect(event) {
  const flash = document.createElement('div');
  flash.classList.add('flash-effect');

  // –ü–æ–ª—É—á–∞–µ–º –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –∫–ª–∏–∫–∞ –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
  const x = event.clientX;
  const y = event.clientY;

  // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∞–±—Å–æ–ª—é—Ç–Ω–æ–µ –ø–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ –≤—Å–µ–π —Å—Ç—Ä–∞–Ω–∏—Ü–µ
  flash.style.left = `${x - 25}px`;
  flash.style.top = `${y - 25}px`;

  // –î–æ–±–∞–≤–ª—è–µ–º —ç—Ñ—Ñ–µ–∫—Ç –≤ body, —á—Ç–æ–±—ã –æ–Ω –ø–æ—è–≤–ª—è–ª—Å—è –ø–æ–≤–µ—Ä—Ö –≤—Å–µ–≥–æ
  document.body.appendChild(flash);

  // –£–¥–∞–ª—è–µ–º —ç–ª–µ–º–µ–Ω—Ç –ø–æ—Å–ª–µ –∞–Ω–∏–º–∞—Ü–∏–∏
  setTimeout(() => {
    flash.remove();
  }, 300);
}

   // –°–æ–∑–¥–∞–Ω–∏–µ –º–æ–Ω–µ—Ç—ã
  function spawnCoinDrop(event) {
    const coin = document.createElement('div');
    coin.classList.add('coin_drop');

    coin.style.left = `${event.clientX - 20}px`;
    coin.style.top = `${event.clientY - 20}px`;

    coinContainer.appendChild(coin);
    coin.addEventListener('animationend', () => coin.remove());
  }

  clickButton.addEventListener('click', () => {
    clickButton.classList.add('active');
    setTimeout(() => clickButton.classList.remove('active'), 300);
  });
});

function createFireEffect(event) {
  const fire = document.createElement('div');
  fire.classList.add('fire-effect');

  const x = event.clientX;
  const y = event.clientY;

  fire.style.left = `${x - 25}px`;
  fire.style.top = `${y - 25}px`;

  document.body.appendChild(fire);

  setTimeout(() => {
    fire.remove();
  }, 1000); // –í—Ä–µ–º—è –¥–µ–π—Å—Ç–≤–∏—è –æ–≥–Ω—è - 1 —Å–µ–∫—É–Ω–¥–∞
}
